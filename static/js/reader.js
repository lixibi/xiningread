// ÈòÖËØªÂô®‰∫§‰∫íÂäüËÉΩ - ÈíàÂØπÂ¢®Ê∞¥Â±è‰ºòÂåñ

document.addEventListener('DOMContentLoaded', function() {
    const readingArea = document.getElementById('reading-area');
    const fileContent = document.querySelector('.file-content') || document.querySelector('.markdown-content');
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');
    const readerContainer = document.getElementById('reader-container');

    // Â≠ó‰ΩìÂ§ßÂ∞èÊéßÂà∂
    let currentFontSize = 18;
    const fontSmallerBtn = document.getElementById('font-smaller');
    const fontLargerBtn = document.getElementById('font-larger');

    // ÊµèËßàÂô®ÂÖ®Â±èÊéßÂà∂
    const fullscreenBtn = document.getElementById('fullscreen-browser');



    // ‰π¶Á≠æÊéßÂà∂
    const bookmarkBtn = document.getElementById('bookmark-btn');
    const bookmarkSaveBtn = document.getElementById('bookmark-save');
    const currentFilePath = window.location.search;

    // ÁøªÈ°µÊéßÂà∂
    const pageUpBtn = document.getElementById('page-up');
    const pageDownBtn = document.getElementById('page-down');
    const pageNavigation = document.getElementById('page-navigation');

    // Â∑•ÂÖ∑Ê†èÊéßÂà∂
    const controlToggle = document.getElementById('control-toggle');
    const controlButtons = document.getElementById('control-buttons');
    const readerControls = document.getElementById('reader-controls');
    let isControlsCollapsed = false;
    
    // Â≠ó‰ΩìÂ§ßÂ∞èË∞ÉÊï¥
    fontSmallerBtn.addEventListener('click', function() {
        if (currentFontSize > 12) {
            currentFontSize -= 2;
            fileContent.style.fontSize = currentFontSize + 'px';
            saveSettings();
        }
    });
    
    fontLargerBtn.addEventListener('click', function() {
        if (currentFontSize < 32) {
            currentFontSize += 2;
            fileContent.style.fontSize = currentFontSize + 'px';
            saveSettings();
        }
    });


    
    // ÊµèËßàÂô®ÂÖ®Â±èÂàáÊç¢
    if (fullscreenBtn) {
        fullscreenBtn.addEventListener('click', function() {
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                document.documentElement.requestFullscreen();
            }
        });

        // ÁõëÂê¨ÂÖ®Â±èÁä∂ÊÄÅÂèòÂåñ
        document.addEventListener('fullscreenchange', function() {
            if (document.fullscreenElement) {
                fullscreenBtn.textContent = 'üî≤ ÈÄÄÂá∫ÂÖ®Â±è';
            } else {
                fullscreenBtn.textContent = 'üî≥ ÊµèËßàÂô®ÂÖ®Â±è';
            }
        });
    }

    // Â∑•ÂÖ∑Ê†èÊî∂Ëµ∑/Â±ïÂºÄ
    controlToggle.addEventListener('click', function() {
        isControlsCollapsed = !isControlsCollapsed;
        if (isControlsCollapsed) {
            readerControls.classList.add('collapsed');
            controlToggle.textContent = '‚öôÔ∏è Â±ïÂºÄËÆæÁΩÆ';
        } else {
            readerControls.classList.remove('collapsed');
            controlToggle.textContent = '‚öôÔ∏è Êî∂Ëµ∑ËÆæÁΩÆ';
        }
        saveSettings();
    });

    // ÁøªÈ°µÂäüËÉΩ
    const pageHeight = window.innerHeight * 0.8; // ÊØèÊ¨°ÁøªÈ°µ80%Â±èÂπïÈ´òÂ∫¶

    pageUpBtn.addEventListener('click', function() {
        window.scrollBy({
            top: -pageHeight,
            behavior: 'auto' // Â¢®Ê∞¥Â±è‰∏ç‰ΩøÁî®smoothÊªöÂä®
        });
    });

    pageDownBtn.addEventListener('click', function() {
        window.scrollBy({
            top: pageHeight,
            behavior: 'auto' // Â¢®Ê∞¥Â±è‰∏ç‰ΩøÁî®smoothÊªöÂä®
        });
    });

    // ÁøªÈ°µÊåâÈíÆÊãñÂä®ÂäüËÉΩ
    let isDragging = false;
    let dragOffset = { x: 0, y: 0 };

    pageNavigation.addEventListener('mousedown', function(e) {
        // Âè™ÊúâÁÇπÂáªÁøªÈ°µÊåâÈíÆÂÆπÂô®Êú¨Ë∫´ÊâçÂºÄÂßãÊãñÂä®ÔºåÁÇπÂáªÊåâÈíÆ‰∏çÊãñÂä®
        if (e.target === pageNavigation) {
            isDragging = true;
            const rect = pageNavigation.getBoundingClientRect();
            dragOffset.x = e.clientX - rect.left;
            dragOffset.y = e.clientY - rect.top;
            e.preventDefault();
        }
    });

    // Èò≤Ê≠¢ÁøªÈ°µÊåâÈíÆÁÇπÂáªÊó∂Ëß¶ÂèëÊãñÂä®
    pageUpBtn.addEventListener('mousedown', function(e) {
        e.stopPropagation();
    });

    pageDownBtn.addEventListener('mousedown', function(e) {
        e.stopPropagation();
    });

    document.addEventListener('mousemove', function(e) {
        if (isDragging) {
            const x = e.clientX - dragOffset.x;
            const y = e.clientY - dragOffset.y;

            // ÈôêÂà∂Âú®Â±èÂπïËåÉÂõ¥ÂÜÖ
            const maxX = window.innerWidth - pageNavigation.offsetWidth;
            const maxY = window.innerHeight - pageNavigation.offsetHeight;

            pageNavigation.style.right = 'auto';
            pageNavigation.style.left = Math.max(0, Math.min(x, maxX)) + 'px';
            pageNavigation.style.top = Math.max(0, Math.min(y, maxY)) + 'px';
            pageNavigation.style.transform = 'none';
        }
    });

    document.addEventListener('mouseup', function() {
        isDragging = false;
    });

    // ‰π¶Á≠æÂäüËÉΩ
    function getBookmarkKey() {
        return 'bookmark_' + btoa(currentFilePath);
    }

    function getCurrentProgress() {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const scrollHeight = document.documentElement.scrollHeight - window.innerHeight;
        return scrollHeight > 0 ? (scrollTop / scrollHeight) * 100 : 0;
    }

    function saveBookmark() {
        const progress = getCurrentProgress();
        localStorage.setItem(getBookmarkKey(), progress.toFixed(2));
        alert(`‰π¶Á≠æÂ∑≤‰øùÂ≠òÔºÅÂΩìÂâç‰ΩçÁΩÆÔºö${progress.toFixed(1)}%`);
    }

    function loadBookmark() {
        const saved = localStorage.getItem(getBookmarkKey());
        if (saved) {
            const progress = parseFloat(saved);
            const scrollHeight = document.documentElement.scrollHeight - window.innerHeight;
            const scrollPosition = (progress / 100) * scrollHeight;

            if (confirm(`ÂèëÁé∞‰π¶Á≠æ‰ΩçÁΩÆÔºö${progress}%ÔºåÊòØÂê¶Ë∑≥ËΩ¨Ôºü`)) {
                window.scrollTo(0, scrollPosition);
                return true;
            }
        }
        return false;
    }

    function hasBookmark() {
        return localStorage.getItem(getBookmarkKey()) !== null;
    }

    // ‰π¶Á≠æÊåâÈíÆ‰∫ã‰ª∂
    if (bookmarkBtn) {
        bookmarkBtn.addEventListener('click', function() {
            if (hasBookmark()) {
                if (!loadBookmark()) {
                    // Áî®Êà∑ÈÄâÊã©‰∏çË∑≥ËΩ¨ÔºåËØ¢ÈóÆÊòØÂê¶Êõ¥Êñ∞‰π¶Á≠æ
                    if (confirm('ÊòØÂê¶Êõ¥Êñ∞‰π¶Á≠æÂà∞ÂΩìÂâç‰ΩçÁΩÆÔºü')) {
                        saveBookmark();
                    }
                }
            } else {
                saveBookmark();
            }
        });
    }

    if (bookmarkSaveBtn) {
        bookmarkSaveBtn.addEventListener('click', function() {
            saveBookmark();
        });
    }
    
    // ÊªöÂä®ËøõÂ∫¶Ë∑üË∏™
    function updateProgress() {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const scrollHeight = document.documentElement.scrollHeight - window.innerHeight;
        const progress = scrollHeight > 0 ? (scrollTop / scrollHeight) * 100 : 0;
        
        progressFill.style.width = progress + '%';
        progressText.textContent = Math.round(progress) + '%';
    }
    
    // ÁõëÂê¨ÊªöÂä®‰∫ã‰ª∂ÔºàËäÇÊµÅÂ§ÑÁêÜÔºâ
    let scrollTimeout;
    window.addEventListener('scroll', function() {
        if (scrollTimeout) {
            clearTimeout(scrollTimeout);
        }
        scrollTimeout = setTimeout(updateProgress, 100);
    });
    
    // ÈîÆÁõòÂø´Êç∑ÈîÆ
    document.addEventListener('keydown', function(e) {
        switch(e.key) {
            case 'ArrowUp':
                if (e.ctrlKey) {
                    e.preventDefault();
                    fontLargerBtn.click();
                } else {
                    e.preventDefault();
                    pageUpBtn.click();
                }
                break;
            case 'ArrowDown':
                if (e.ctrlKey) {
                    e.preventDefault();
                    fontSmallerBtn.click();
                } else {
                    e.preventDefault();
                    pageDownBtn.click();
                }
                break;
            case 'ArrowLeft':
                e.preventDefault();
                pageUpBtn.click();
                break;
            case 'ArrowRight':
                e.preventDefault();
                pageDownBtn.click();
                break;
            case 'PageUp':
                e.preventDefault();
                pageUpBtn.click();
                break;
            case 'PageDown':
                e.preventDefault();
                pageDownBtn.click();
                break;
            case 'f':
                if (e.ctrlKey && fullscreenBtn) {
                    e.preventDefault();
                    fullscreenBtn.click();
                }
                break;
            case 'Home':
                window.scrollTo(0, 0);
                break;
            case 'End':
                window.scrollTo(0, document.body.scrollHeight);
                break;
        }
    });
    
    // ‰øùÂ≠òÁî®Êà∑ËÆæÁΩÆÂà∞localStorage
    function saveSettings() {
        const settings = {
            fontSize: currentFontSize,
            controlsCollapsed: isControlsCollapsed
        };
        localStorage.setItem('readerSettings', JSON.stringify(settings));
    }
    
    // Âä†ËΩΩÁî®Êà∑ËÆæÁΩÆ
    function loadSettings() {
        const saved = localStorage.getItem('readerSettings');
        if (saved) {
            try {
                const settings = JSON.parse(saved);

                if (settings.fontSize) {
                    currentFontSize = settings.fontSize;
                    if (fileContent) {
                        fileContent.style.fontSize = currentFontSize + 'px';
                    }
                }

                if (settings.controlsCollapsed !== undefined) {
                    isControlsCollapsed = settings.controlsCollapsed;
                    if (isControlsCollapsed) {
                        readerControls.classList.add('collapsed');
                        controlToggle.textContent = '‚öôÔ∏è Â±ïÂºÄËÆæÁΩÆ';
                    }
                }


            } catch (e) {
                console.log('ËÆæÁΩÆÂä†ËΩΩÂ§±Ë¥•:', e);
            }
        }
    }
    
    // Ëá™Âä®‰øùÂ≠òÈòÖËØª‰ΩçÁΩÆ
    function saveReadingPosition() {
        const scrollPosition = window.pageYOffset;
        const url = window.location.href;
        localStorage.setItem('readingPosition_' + btoa(url), scrollPosition);
    }
    
    // ÊÅ¢Â§çÈòÖËØª‰ΩçÁΩÆ
    function restoreReadingPosition() {
        const url = window.location.href;
        const saved = localStorage.getItem('readingPosition_' + btoa(url));
        if (saved) {
            setTimeout(() => {
                window.scrollTo(0, parseInt(saved));
            }, 100);
        }
    }
    
    // È°µÈù¢Âç∏ËΩΩÊó∂‰øùÂ≠ò‰ΩçÁΩÆ
    window.addEventListener('beforeunload', saveReadingPosition);
    
    // ÂàùÂßãÂåñ
    loadSettings();

    // Ê£ÄÊü•‰π¶Á≠æÔºà‰ºòÂÖàÁ∫ßÈ´ò‰∫éÈòÖËØª‰ΩçÁΩÆÔºâ
    setTimeout(() => {
        if (hasBookmark()) {
            loadBookmark();
        } else {
            restoreReadingPosition();
        }
        updateProgress();
    }, 100);
    
    // Ê∑ªÂä†Âø´Êç∑ÈîÆÊèêÁ§∫
    const helpText = document.createElement('div');
    helpText.innerHTML = `
        <div style="position: fixed; bottom: 10px; right: 10px; background: #fff; border: 2px solid #000; padding: 10px; font-size: 12px; display: none; z-index: 10001;" id="help-panel">
            <strong>Âø´Êç∑ÈîÆ:</strong><br>
            Ctrl+‚Üë/‚Üì: Ë∞ÉÊï¥Â≠ó‰Ωì<br>
            Ctrl+F: ÊµèËßàÂô®ÂÖ®Â±è<br>
            ‚Üë/‚Üì/‚Üê/‚Üí: ÁøªÈ°µ<br>
            PageUp/PageDown: ÁøªÈ°µ<br>
            Home/End: Ë∑≥ËΩ¨È¶ñÂ∞æ<br>
            F1: ÊòæÁ§∫/ÈöêËóèÂ∏ÆÂä©<br><br>
            <strong>Êìç‰Ωú:</strong><br>
            ÁøªÈ°µÊåâÈíÆÂèØÊãñÂä®<br>
            Â∑•ÂÖ∑Ê†èÂèØÊî∂Ëµ∑<br>
            üîñ‰π¶Á≠æ: ‰øùÂ≠ò/Ë∑≥ËΩ¨‰ΩçÁΩÆ<br>
            üíæ: Âø´ÈÄü‰øùÂ≠ò‰π¶Á≠æ
        </div>
    `;
    document.body.appendChild(helpText);
    
    // ÊòæÁ§∫/ÈöêËóèÂ∏ÆÂä©
    let helpVisible = false;
    document.addEventListener('keydown', function(e) {
        if (e.key === 'F1' || (e.key === '?' && e.shiftKey)) {
            e.preventDefault();
            const helpPanel = document.getElementById('help-panel');
            helpVisible = !helpVisible;
            helpPanel.style.display = helpVisible ? 'block' : 'none';
        }
    });
});
