{% extends "base.html" %}

{% block title %}{{ filename }} - å¸Œå®é˜…è¯»{% endblock %}

{% block navigation %}
<nav class="reader-nav">
    <a href="{{ url_for('index') }}" class="nav-link">ğŸ  è¿”å›æ–‡ä»¶åˆ—è¡¨</a>
    <span class="separator">|</span>
    <span class="current-file">ğŸ“„ {{ filename }}</span>
    <span class="separator">|</span>
    <a href="{{ url_for('download_file', path=file_path) }}" class="nav-link">â¬‡ï¸ ä¸‹è½½</a>
</nav>
{% endblock %}

{% block content %}
<div class="pdf-reader-container">
    <div class="pdf-controls">
        <button id="pdf-fullscreen" class="btn btn-control">ğŸ”³ æµè§ˆå™¨å…¨å±</button>
        <span class="pdf-info">PDFæ–‡ä»¶ï¼š{{ filename }}</span>
    </div>
    
    <div class="pdf-viewer">
        <iframe
            src="{{ url_for('view_file', path=file_path) }}"
            width="100%"
            height="800px"
            style="border: 2px solid #000;">
            <p>æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒPDFé¢„è§ˆã€‚<a href="{{ url_for('download_file', path=file_path) }}">ç‚¹å‡»ä¸‹è½½PDFæ–‡ä»¶</a></p>
        </iframe>
    </div>
</div>

<!-- æµ®åŠ¨ç¿»é¡µæŒ‰é’® -->
<div class="page-navigation" id="page-navigation">
    <button id="page-up" class="page-btn page-up" title="ä¸Šä¸€é¡µ (Page Up)">â–²</button>
    <button id="page-down" class="page-btn page-down" title="ä¸‹ä¸€é¡µ (Page Down)">â–¼</button>
</div>
{% endblock %}

{% block scripts %}
{{ super() }} {# Ensures scripts from base.html like recent_reads.js are loaded first #}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const filePath = "{{ file_path|e|safe }}";
    const originalFilename = "{{ filename|e|safe }}";

    // Update displayed title in .pdf-info and .current-file (if it exists from base)
    const pdfInfoSpan = document.querySelector('.pdf-controls .pdf-info');
    const currentFileSpan = document.querySelector('.reader-nav .current-file'); // From base nav block

    if (typeof metadataEditorManager !== 'undefined') {
        const displayTitle = metadataEditorManager.getDisplayTitle(filePath, originalFilename);
        if (pdfInfoSpan) {
            pdfInfoSpan.textContent = `PDFæ–‡ä»¶ï¼š${displayTitle}`;
        }
        if (currentFileSpan) { // Update breadcrumb/nav title if that element is present
            currentFileSpan.textContent = `ğŸ“„ ${displayTitle}`;
        }
    }


    if (typeof recentReadsManager !== 'undefined' && filePath && originalFilename) {
        recentReadsManager.addRecentRead(filePath, originalFilename);
    } else {
        console.warn('RecentReadsManager not available or filePath/originalFilename missing for pdf_reader.html');
    }

    // Existing PDF reader specific JS follows
    const fullscreenBtn = document.getElementById('pdf-fullscreen');
    
    // æµè§ˆå™¨å…¨å±åŠŸèƒ½
    fullscreenBtn.addEventListener('click', function() {
        if (document.fullscreenElement) {
            document.exitFullscreen();
        } else {
            document.documentElement.requestFullscreen();
        }
    });
    
    // ç›‘å¬å…¨å±çŠ¶æ€å˜åŒ–
    document.addEventListener('fullscreenchange', function() {
        if (document.fullscreenElement) {
            fullscreenBtn.textContent = 'ğŸ”² é€€å‡ºå…¨å±';
        } else {
            fullscreenBtn.textContent = 'ğŸ”³ æµè§ˆå™¨å…¨å±';
        }
    });
    
    // ç¿»é¡µåŠŸèƒ½ï¼ˆå¯¹äºPDFå¯èƒ½éœ€è¦ç‰¹æ®Šå¤„ç†ï¼‰
    const pageUpBtn = document.getElementById('page-up');
    const pageDownBtn = document.getElementById('page-down');
    const pageHeight = window.innerHeight * 0.8;
    
    pageUpBtn.addEventListener('click', function() {
        window.scrollBy({
            top: -pageHeight,
            behavior: 'auto'
        });
    });
    
    pageDownBtn.addEventListener('click', function() {
        window.scrollBy({
            top: pageHeight,
            behavior: 'auto'
        });
    });
    
    // é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', function(e) {
        switch(e.key) {
            case 'PageUp':
            case 'ArrowUp':
            case 'ArrowLeft':
                e.preventDefault();
                pageUpBtn.click();
                break;
            case 'PageDown':
            case 'ArrowDown':
            case 'ArrowRight':
                e.preventDefault();
                pageDownBtn.click();
                break;
        }
    });
});
</script>
{% endblock %}
