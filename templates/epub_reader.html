{% extends "base.html" %}

{% block title %}{{ filename }} - å¸Œå®é˜…è¯»{% endblock %}

{% block navigation %}
<nav class="reader-nav">
    <a href="{{ url_for('index') }}" class="nav-link">ğŸ  è¿”å›æ–‡ä»¶åˆ—è¡¨</a>
    <span class="separator">|</span>
    <span class="current-file">ğŸ“š {{ filename }}</span>
    <span class="separator">|</span>
    <a href="{{ url_for('download_file', path=file_path) }}" class="nav-link">â¬‡ï¸ ä¸‹è½½</a>
</nav>
{% endblock %}

{% block content %}
<div class="epub-reader-container">
    <div class="epub-controls">
        <button class="control-toggle" id="control-toggle">âš™ï¸ é˜…è¯»è®¾ç½®</button>
        <div class="control-buttons" id="control-buttons">
            <button id="font-smaller" class="btn btn-control">ğŸ”¤- ç¼©å°å­—ä½“</button>
            <button id="font-larger" class="btn btn-control">ğŸ”¤+ æ”¾å¤§å­—ä½“</button>
            <button id="fullscreen-browser" class="btn btn-control">ğŸ”³ æµè§ˆå™¨å…¨å±</button>
            <button id="bookmark-btn" class="btn btn-control">ğŸ”– ä¹¦ç­¾</button>
        </div>
    </div>

    <div class="epub-viewer">
        {% if epub_data %}
            <div class="epub-header">
                <h1 class="epub-title">{{ epub_data.title }}</h1>
                <p class="epub-author">ä½œè€…ï¼š{{ epub_data.author }}</p>
            </div>

            <div class="epub-content" id="epub-content">
                {{ epub_data.content|safe }}
            </div>
        {% elif error %}
            <div class="epub-error">
                <h3>âŒ EPUBè§£æå¤±è´¥</h3>
                <p>{{ error }}</p>
                <div class="epub-actions">
                    <a href="{{ url_for('download_file', path=file_path) }}" class="btn btn-primary">
                        ğŸ“¥ ä¸‹è½½EPUBæ–‡ä»¶
                    </a>
                </div>
            </div>
        {% else %}
            <div class="epub-notice">
                <h3>ğŸ“š EPUBç”µå­ä¹¦é˜…è¯»</h3>
                <p>EPUBæ–‡ä»¶éœ€è¦ä¸“é—¨çš„é˜…è¯»å™¨æ¥æ˜¾ç¤ºã€‚æ‚¨å¯ä»¥ï¼š</p>
                <ul>
                    <li><strong>ä¸‹è½½æ–‡ä»¶</strong>ï¼šä½¿ç”¨ä¸“ä¸šçš„EPUBé˜…è¯»å™¨ï¼ˆå¦‚Adobe Digital Editionsã€Calibreç­‰ï¼‰</li>
                    <li><strong>åœ¨çº¿é˜…è¯»</strong>ï¼šå°†æ–‡ä»¶ä¸Šä¼ åˆ°åœ¨çº¿EPUBé˜…è¯»å™¨</li>
                    <li><strong>è½¬æ¢æ ¼å¼</strong>ï¼šä½¿ç”¨Calibreç­‰å·¥å…·è½¬æ¢ä¸ºPDFæˆ–å…¶ä»–æ ¼å¼</li>
                </ul>

                <div class="epub-actions">
                    <a href="{{ url_for('download_file', path=file_path) }}" class="btn btn-primary">
                        ğŸ“¥ ä¸‹è½½EPUBæ–‡ä»¶
                    </a>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- ç«–ç›´è¿›åº¦æ¡ -->
    <div class="reading-progress" id="reading-progress">
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>
        <div class="progress-info">
            <span id="progress-text">0%</span>
        </div>
    </div>
</div>

<!-- æµ®åŠ¨ç¿»é¡µæŒ‰é’® -->
<div class="page-navigation" id="page-navigation">
    <button id="page-up" class="page-btn page-up" title="ä¸Šä¸€é¡µ (Page Up)">â–²</button>
    <button id="page-down" class="page-btn page-down" title="ä¸‹ä¸€é¡µ (Page Down)">â–¼</button>
    <button id="bookmark-save" class="page-btn bookmark-btn" title="ä¿å­˜ä¹¦ç­¾">ğŸ’¾</button>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/reader.js') }}"></script>
<script>
// EPUBç‰¹å®šçš„æ ·å¼è°ƒæ•´
document.addEventListener('DOMContentLoaded', function() {
    const epubContent = document.getElementById('epub-content');

    // ä¸ºEPUBå†…å®¹æ·»åŠ å¢¨æ°´å±ä¼˜åŒ–æ ·å¼
    if (epubContent) {
        epubContent.style.fontFamily = "'Times New Roman', 'SimSun', serif";
        epubContent.style.lineHeight = "1.8";
        epubContent.style.color = "#000";
        epubContent.style.backgroundColor = "#fff";
        epubContent.style.maxWidth = "800px";
        epubContent.style.margin = "0 auto";
        epubContent.style.padding = "20px";

        // è°ƒæ•´EPUBå†…å®¹ä¸­çš„æ ·å¼ä»¥é€‚é…å¢¨æ°´å±
        const allElements = epubContent.querySelectorAll('*');
        allElements.forEach(element => {
            // ç§»é™¤å¯èƒ½çš„å½©è‰²èƒŒæ™¯
            const computedStyle = window.getComputedStyle(element);
            if (computedStyle.backgroundColor && computedStyle.backgroundColor !== 'rgba(0, 0, 0, 0)' && computedStyle.backgroundColor !== 'transparent') {
                element.style.backgroundColor = '#f8f8f8';
            }

            // ç¡®ä¿æ–‡å­—é¢œè‰²ä¸ºé»‘è‰²
            if (computedStyle.color && computedStyle.color !== 'rgb(0, 0, 0)') {
                element.style.color = '#000';
            }

            // å¤„ç†æ®µè½ç¼©è¿›
            if (element.tagName === 'P') {
                element.style.textIndent = '2em';
                element.style.margin = '1em 0';
            }
        });
    }
});
</script>
{% endblock %}
