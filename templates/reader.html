{% extends "base.html" %}

{% block title %}{{ filename }} - å¸Œå®é˜…è¯»{% endblock %}

{% block navigation %}
<nav class="reader-nav">
    <a href="{{ url_for('index') }}" class="nav-link">ğŸ  è¿”å›æ–‡ä»¶åˆ—è¡¨</a>
    <span class="separator">|</span>
    <span class="current-file">ğŸ“„ {{ filename }}</span>
    <span class="separator">|</span>
    <a href="{{ url_for('download_file', path=file_path) }}" class="nav-link">â¬‡ï¸ ä¸‹è½½</a>
</nav>
{% endblock %}

{% block content %}
<div class="reader-container" id="reader-container">
    <div class="reader-controls" id="reader-controls">
        <button class="control-toggle" id="control-toggle">âš™ï¸ é˜…è¯»è®¾ç½®</button>
        <div class="control-buttons" id="control-buttons">
            <button id="font-smaller" class="btn btn-control">ğŸ”¤- ç¼©å°å­—ä½“</button>
            <button id="font-larger" class="btn btn-control">ğŸ”¤+ æ”¾å¤§å­—ä½“</button>
            <button id="fullscreen-browser" class="btn btn-control">ğŸ”³ æµè§ˆå™¨å…¨å±</button>
            <button id="bookmark-btn" class="btn btn-control">ğŸ”– ä¹¦ç­¾</button>
        </div>
    </div>

    <div class="reading-area" id="reading-area">
        {% if file_type == 'markdown' and html_content %}
            <div id="content-container" class="markdown-content"></div> {# Empty container for JS rendering #}
            <script id="full-content-data" type="text/plain" style="display:none;">{{ html_content|safe }}</script>
        {% elif file_type == 'code' %}
            {# Code content is often pre-formatted by Pygments; chunking might break highlighting spans. #}
            {# For now, render code directly. Performance issues with huge code files are less common than huge TXT/MD. #}
            <div class="code-content">
                <div class="code-header">
                    <span class="language-label">{{ language.upper() }}</span>
                    <span class="filename">{{ filename }}</span>
                </div>
                <pre class="code-block language-{{ language }}"><code>{{ content }}</code></pre>
            </div>
        {% elif file_type == 'txt' %}
            <div id="content-container" class="txt-content"></div> {# Empty container for JS rendering #}
            <script id="full-content-data" type="text/plain" style="display:none;">{{ content|e }}</script> {# Escape TXT content just in case #}
        {% else %} {# Handles generic 'text' or unspecified types as plain text #}
            <div id="content-container" class="file-content"></div> {# Empty container for JS rendering #}
            <script id="full-content-data" type="text/plain" style="display:none;">{{ content|e }}</script> {# Escape plain content #}
        {% endif %}
    </div>

    <!-- ç«–ç›´è¿›åº¦æ¡ -->
    <div class="reading-progress" id="reading-progress">
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>
        <div class="progress-info">
            <span id="progress-text">0%</span>
        </div>
    </div>
</div>

<!-- æµ®åŠ¨ç¿»é¡µæŒ‰é’® -->
<div class="page-navigation" id="page-navigation">
    <button id="page-up" class="page-btn page-up" title="ä¸Šä¸€é¡µ (Page Up)">â–²</button>
    <button id="page-down" class="page-btn page-down" title="ä¸‹ä¸€é¡µ (Page Down)">â–¼</button>
    <button id="bookmark-save" class="page-btn bookmark-btn" title="ä¿å­˜ä¹¦ç­¾">ğŸ’¾</button>
</div>
{% endblock %}

{% block scripts %}
{{ super() }} {# Ensures scripts from base.html like recent_reads.js are loaded first #}
<script src="{{ url_for('static', filename='js/reader.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const filePath = "{{ file_path|e|safe }}"; // file_path from backend
    const originalFilename = "{{ filename|e|safe }}"; // filename from backend is original

    // Update displayed title using metadataManager
    const currentFileSpan = document.querySelector('.reader-nav .current-file');
    if (currentFileSpan && typeof metadataEditorManager !== 'undefined') {
        const displayTitle = metadataEditorManager.getDisplayTitle(filePath, originalFilename);
        currentFileSpan.textContent = `ğŸ“„ ${displayTitle}`; // Update the visual title
    }

    // Add to recent reads using original filename
    if (typeof recentReadsManager !== 'undefined' && filePath && originalFilename) {
        recentReadsManager.addRecentRead(filePath, originalFilename);
    } else {
        console.warn('RecentReadsManager not available or filePath/originalFilename missing for reader.html');
    }
});
</script>
{% endblock %}
