{% extends "base.html" %}

{% block title %}æœ¬åœ°æ–‡ä»¶é˜…è¯» Â· å¸Œå®é˜…è¯»{% endblock %}

{% block navigation %}
<nav class="breadcrumb">
    <a href="{{ url_for('index') }}" class="nav-link">ğŸ  é¦–é¡µ</a>
    <a href="{{ url_for('local_reader') }}" class="nav-link current">ğŸ“± æŸ¥çœ‹æœ¬åœ°ä¹¦</a>
</nav>
{% endblock %}

{% block head %}
<style>
.upload-area {
    border: 2px dashed #ccc;
    border-radius: 8px;
    padding: 40px;
    text-align: center;
    margin: 20px 0;
    background-color: #f9f9f9;
    transition: all 0.3s ease;
}

.upload-area:hover {
    border-color: #007bff;
    background-color: #f0f8ff;
}

.upload-area.dragover {
    border-color: #007bff;
    background-color: #e6f3ff;
}

.file-input {
    display: none;
}

.upload-btn {
    background-color: #007bff;
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    margin: 10px;
    transition: background-color 0.3s ease;
}

.upload-btn:hover {
    background-color: #0056b3;
}

.file-info {
    margin: 20px 0;
    padding: 15px;
    background-color: #e9ecef;
    border-radius: 6px;
    display: none;
}

.supported-formats {
    margin: 20px 0;
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 6px;
    border-left: 4px solid #007bff;
}

.format-list {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
}

.format-tag {
    background-color: #007bff;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
}

.read-btn {
    background-color: #28a745;
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    margin: 10px;
    display: none;
}

.read-btn:hover {
    background-color: #218838;
}

.error-message {
    color: #dc3545;
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
    padding: 10px;
    border-radius: 6px;
    margin: 10px 0;
    display: none;
}

.success-message {
    color: #155724;
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
    padding: 10px;
    border-radius: 6px;
    margin: 10px 0;
    display: none;
}
</style>
{% endblock %}

{% block content %}
<div class="local-reader-container">
    <h2>ğŸ“± æœ¬åœ°æ–‡ä»¶é˜…è¯»</h2>
    <p>é€‰æ‹©æ‚¨è®¾å¤‡ä¸Šçš„æ–‡ä»¶è¿›è¡Œé˜…è¯»ï¼Œæ”¯æŒå¤šç§æ ¼å¼çš„æ–‡æ¡£ã€‚</p>
    
    <div class="upload-area" id="uploadArea">
        <div class="upload-content">
            <h3>ğŸ“ é€‰æ‹©æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</h3>
            <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®é€‰æ‹©æ–‡ä»¶ï¼Œæˆ–ç›´æ¥å°†æ–‡ä»¶æ‹–æ‹½åˆ°æ­¤åŒºåŸŸ</p>
            <button type="button" class="upload-btn" onclick="document.getElementById('fileInput').click()">
                ğŸ“‚ é€‰æ‹©æ–‡ä»¶
            </button>
            <input type="file" id="fileInput" class="file-input" accept=".txt,.md,.pdf,.epub,.html,.htm,.py,.js,.css,.json,.xml,.csv,.log,.java,.cpp,.c,.h,.php,.rb,.go,.rs,.swift,.kt,.scala,.sh,.bat,.ps1,.sql,.yaml,.yml">
        </div>
    </div>
    
    <div class="error-message" id="errorMessage"></div>
    <div class="success-message" id="successMessage"></div>
    
    <div class="file-info" id="fileInfo">
        <h4>ğŸ“„ æ–‡ä»¶ä¿¡æ¯</h4>
        <p><strong>æ–‡ä»¶åï¼š</strong><span id="fileName"></span></p>
        <p><strong>æ–‡ä»¶å¤§å°ï¼š</strong><span id="fileSize"></span></p>
        <p><strong>æ–‡ä»¶ç±»å‹ï¼š</strong><span id="fileType"></span></p>
        <button type="button" class="read-btn" id="readBtn">ğŸ“– å¼€å§‹é˜…è¯»</button>
    </div>
    
    <div class="supported-formats">
        <h4>ğŸ¯ æ”¯æŒçš„æ–‡ä»¶æ ¼å¼</h4>
        <p>æœ¬åº”ç”¨æ”¯æŒä»¥ä¸‹æ–‡ä»¶æ ¼å¼çš„åœ¨çº¿é˜…è¯»ï¼š</p>
        <div class="format-list">
            <span class="format-tag">TXT</span>
            <span class="format-tag">MD</span>
            <span class="format-tag">PDF</span>
            <span class="format-tag">EPUB</span>
            <span class="format-tag">HTML</span>
            <span class="format-tag">PY</span>
            <span class="format-tag">JS</span>
            <span class="format-tag">CSS</span>
            <span class="format-tag">JSON</span>
            <span class="format-tag">XML</span>
            <span class="format-tag">CSV</span>
            <span class="format-tag">LOG</span>
        </div>
        <p style="margin-top: 10px; font-size: 14px; color: #666;">
            ä»¥åŠæ›´å¤šç¼–ç¨‹è¯­è¨€æ–‡ä»¶ï¼šJava, C/C++, PHP, Ruby, Go, Rust, Swift, Kotlin, Scala, Shellè„šæœ¬ç­‰
        </p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let selectedFile = null;

// æ–‡ä»¶è¾“å…¥å˜åŒ–å¤„ç†
document.getElementById('fileInput').addEventListener('change', function(e) {
    handleFileSelect(e.target.files[0]);
});

// æ‹–æ‹½å¤„ç†
const uploadArea = document.getElementById('uploadArea');

uploadArea.addEventListener('dragover', function(e) {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', function(e) {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', function(e) {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFileSelect(files[0]);
    }
});

// å¤„ç†æ–‡ä»¶é€‰æ‹©
function handleFileSelect(file) {
    if (!file) return;
    
    selectedFile = file;
    
    // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileSize').textContent = formatFileSize(file.size);
    document.getElementById('fileType').textContent = getFileTypeLabel(file.name);
    
    document.getElementById('fileInfo').style.display = 'block';
    document.getElementById('readBtn').style.display = 'inline-block';
    
    // éšè—é”™è¯¯ä¿¡æ¯
    document.getElementById('errorMessage').style.display = 'none';
    
    // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
    const successMsg = document.getElementById('successMessage');
    successMsg.textContent = 'âœ… æ–‡ä»¶é€‰æ‹©æˆåŠŸï¼ç‚¹å‡»"å¼€å§‹é˜…è¯»"æŒ‰é’®å¼€å§‹é˜…è¯»ã€‚';
    successMsg.style.display = 'block';
}

// æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

// è·å–æ–‡ä»¶ç±»å‹æ ‡ç­¾
function getFileTypeLabel(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    const typeMap = {
        'txt': 'TXT', 'md': 'MD', 'pdf': 'PDF', 'epub': 'EPUB',
        'html': 'HTML', 'htm': 'HTML', 'py': 'PY', 'js': 'JS',
        'css': 'CSS', 'json': 'JSON', 'xml': 'XML', 'csv': 'CSV',
        'log': 'LOG', 'java': 'JAVA', 'cpp': 'C++', 'c': 'C',
        'h': 'H', 'php': 'PHP', 'rb': 'RUBY', 'go': 'GO',
        'rs': 'RUST', 'swift': 'SWIFT', 'kt': 'KOTLIN',
        'scala': 'SCALA', 'sh': 'BASH', 'bat': 'BAT',
        'ps1': 'PS1', 'sql': 'SQL', 'yaml': 'YAML', 'yml': 'YAML'
    };
    return typeMap[ext] || ext.toUpperCase();
}

// å¼€å§‹é˜…è¯»æŒ‰é’®å¤„ç†
document.getElementById('readBtn').addEventListener('click', function() {
    if (!selectedFile) {
        showError('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡ä»¶');
        return;
    }
    
    // åˆ›å»ºFormDataå¯¹è±¡
    const formData = new FormData();
    formData.append('file', selectedFile);
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    this.textContent = 'ğŸ“¤ ä¸Šä¼ ä¸­...';
    this.disabled = true;
    
    // ä¸Šä¼ æ–‡ä»¶
    fetch('/upload_local_file', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // è·³è½¬åˆ°é˜…è¯»é¡µé¢
            window.location.href = data.read_url;
        } else {
            showError(data.error || 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥');
            this.textContent = 'ğŸ“– å¼€å§‹é˜…è¯»';
            this.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
        this.textContent = 'ğŸ“– å¼€å§‹é˜…è¯»';
        this.disabled = false;
    });
});

// æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
function showError(message) {
    const errorMsg = document.getElementById('errorMessage');
    errorMsg.textContent = 'âŒ ' + message;
    errorMsg.style.display = 'block';
    
    // éšè—æˆåŠŸä¿¡æ¯
    document.getElementById('successMessage').style.display = 'none';
}
</script>
{% endblock %}
